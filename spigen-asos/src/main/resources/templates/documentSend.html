<!DOCTYPE html>
<html lang="en">
  <!-- 공통 Config -->
  <head th:replace="config::configFragment">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Jekyll v4.0.1">
  </head>
  <!-- 공통 헤더-->
  <header th:replace="topbar::topbarFragment"></header>
  <body>
  	<form name="menuFrm">
   		<input type="hidden"> 	
   	</form>
	<form id="printFrm" name="printFrm">
		<input type ="hidden" id="chkFiles"  name="chkFiles" value="">
	</form>
	<form id="searchFrm" name ="searchFrm">
    <div class="container-fluid">
      <div class="row">	
      	<!-- left메뉴 -->
  		<nav th:replace="nav::sidebarMenu"></nav> 
		<main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
          <div class="pt-3 pb-2 mb-3 border-bottom">
            <h2>수출입 서류 조회(은행)</h2>
		  	<div class="search" >
		    	<form id="qryFrm" name="qryFrm" method="post" action="" class="qryFrm">
		        	<ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			  <li class="title2">                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
			  <label class="lb1"><span class="tx">이체ID</span></label>                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			  <input type="text" id="laufi" name="laufi" hname="이체ID" maxlength="100" class="inp_type">                                                                                                                                                                                                                                                                                                                                                                                                                                         
			  </li>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
			  <li class="title2">                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			  <label class="lb1"><span>전송여부</span></label>          
			  <select id="sendYn" name="sendYn" class="inp_type_w70">
			  	<option value="" selected="selected">전체</option>
			  	<option value="Y">전송</option>
			  	<option value="N" >미전송</option>
			  	<option value="R" >재전송</option>
			  </select>                                                                                                                                                                                                                                                                                                                                                                                                                                         
			  </li>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
			</ul>
			<ul>
			  <li class="title4">                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
			  <label class="lb1"><span class="tx">* 이체일자</span></label>			  
			  <input type="date" id="qryBfr" name="qryBfr" hname="조회기간" maxlength="6" class="inp_type_w70" value="2020-08-13">&nbsp;&nbsp;~&nbsp;                                                                                                                                                                                                                                                                                                                                                                                                                                      
			  <input type="date" id="qryAftr" name="qryAftr" hname="조회기간" maxlength="6" class="inp_type_w70" value="2020-08-14">                                                                                                                                                                                                                                                                                                                                                                                                                                        
			  </li> 
			  <li class="title5">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
				<button type="button" id="qryBtn" name="qryBtn" value="조회" onclick="qryFileList()" class="btn btn-secondary btn-sm">
			  	<span data-feather="search"></span> 조회
			  	</button>
			  </li>
			</ul>                  
		        </form>
		        
		    </div>
		   	<article class="article_list_table2">
            <div class="list-table2">
              <table id="gridList" class="table table-striped table-sm" style="width: 110%">
              	<colgroup>
					<col width="3%">
					<col width="7%">
					<col width="9%">
					<col width="9%">
					<col width="13%">
					<col width="7%">
					<col width="9%">
					<col width="8%">
					<col width="20%">
					<col width="8%">
					<col width="7%">
				</colgroup>
                <thead>
                  <tr>
					<th scope="col" class='center'><input type="checkbox" id="checkAll" class="checkAll"></th>
					<th scope="col" class='center'>이체일자</th>
					<th scope="col" class='center'>이체ID</th>
					<th scope="col" class='center'>발생전표번호</th>
					<th scope="col" class='center'>공급업체명</th>					
					<th scope="col" class='center'>송금통화</th>					
					<th scope="col" class='center'>송금액</th>					
					<th scope="col" class='center'>송금은행</th>					
					<th scope="col" class='center'>파일명</th>
					<th scope="col" class='center'>파일형식</th>
					<th scope="col" class='center'>전송여부</th>
                  </tr>
                </thead>
                <tbody>
	                <tr>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
                </tbody>
              </table>
            </div>
            <div class="btnDivBtm" style="padding-top: 2px">
              	<button type="button" id="faxBtn" name="faxBtn" value="FAX" onclick="destinationPopupCall()" class="btn btn-outline-primary btn-sm" style="display: none;">
              	<span data-feather="phone-forwarded"></span> FAX
              	</button>
            </div>
            </article>
        	<!-- pagging -->
			<div class="paginate_complex">
				<div id="paging" class="paging">
					<div id="boardNavigation" class="boardNavigation">
						<input type="hidden" id="pageIndex" name="pageIndex" value="1"/>
						<div id="pagination" class="pagination"></div>
					</div>
				</div>
			</div>
			<!-- //pagging -->     
          </div>
      </main>
      </div>
     </div>
     </form>
<script>
$(document).ready(function(){
	
	//전체선택
	$(".checkAll").click(function(){
		$(".chkList").prop("checked", this.checked);
	});
	
	$('#qryBfr').val(getDate(0));
	$('#qryAftr').val(getDate(0));
	
	feather.replace();
	
	fnInitMenu("nav2");

});

function qryFileList(){
	
	var sendData = $('#searchFrm').serialize();
	
   	$.ajax({
          type : 'POST',
          data : sendData,
          dataType : 'json',
          url :  '/file/fileMgrListQry',
          beforeSend : function(xhr)
          {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token); 
          }, 
          success : function(result) {
             //alert(result.resultList[0]);
             onSuccess(result);
          },
          error : function(request,status){
              alert("조회 실패");
          }
	});
	
}

function onSuccess(result){
	
	var htmltext="";    
    if(result.resultList.length == 0) {
        htmltext += "<tr>";
        htmltext += "<td class='center' colspan=\"15\">조회 결과가 없습니다.</td>";
        htmltext += "</tr>";
		$('#faxBtn').hide();
    }else{

		for(var n = 0 ; n<result.resultList.length ; n ++){
			var resultVO = result.resultList[n];      
		    htmltext += "<tr>";
		    htmltext += "<td class='center'><input type='checkbox' name='chkList' value='"+resultVO.filePath+":"+resultVO.fileNm+"' class='chkList'><input type='hidden' value='"+resultVO.sendYn+"'><input type='hidden' value='"+resultVO.eviSeq+":"+resultVO.fileSeq+"'></td>";
		    htmltext += "<input type='hidden' value='"+resultVO.fileType+"'>";
		    htmltext += "<input type='hidden' value='"+resultVO.laufd+":"+resultVO.laufi+":"+resultVO.vblnr+":"+resultVO.zbukr+"'>";
		    htmltext += "<td class='center'>"+resultVO.laufd+"</td>";
		    htmltext += "<td class='center'>"+resultVO.laufi+"</td>";
		    htmltext += "<td class='center'>"+resultVO.belnr+"</td>";
		    htmltext += "<td class='center'>"+resultVO.name1+"</td>";
		    htmltext += "<td class='center'>"+resultVO.remtCurcd+"</td>";
		    htmltext += "<td class='center'>"+resultVO.ebnkFamt+"</td>";
		    htmltext += "<td class='center'>"+resultVO.dracBicNm+"</td>";
		    htmltext += "<td class='center'><a href=\"javascript:fileViewer(this,\'"+resultVO.filePath+"\',\'"+resultVO.fileType+"\',\'"+resultVO.fileNm+"\', event)\" style='cursor:hand;'>"+resultVO.fileNm+"</a></td>";
		    htmltext += "<td class='center type'>"+resultVO.fileType+"</td>";
		    htmltext += "<td class='center'>"+resultVO.sendYnNm+"</td>";
		    htmltext += "</tr>";
		}
		$('#faxBtn').show();
    }
    $("#gridList > tbody").html(htmltext);
    $("#pagination").quickPager( {
        pageSize: result.paginationInfo.pageSize,
        pageUnit: result.paginationInfo.recordCountPerPage,
        pageIndexId: "pageIndex",
        callback:function() {
        	qryFileList();
        },
        currentPage: result.paginationInfo.currentPageNo,
        totalCount: result.paginationInfo.totalRecordCount,
        searchUrl: "#_"
    });
}

//수신처 선택 팝업 호출
function destinationPopupCall(){
	
	if($('input[name="chkList"]:checked').size()==0){
		alert("전송할 서류를 선택해주세요.");
		return;
	}
	var typeArr = ['xls', 'xlsx', 'pdf', 'jpg', 'jpeg', 'PDF'];

	var dracBicNm;
	var flag = true;
	$('input[name="chkList"]:checked').each(function (i) {  
		if($.inArray($('input[name="chkList"]:checked').eq(i).parent().next().val(), typeArr) < 0){
			flag = false;
		}
		dracBicNm = $('input[name="chkList"]:checked').eq(i).parent().next().next().next().next().next().next().next().next().next().html();
	});  
	
	
	if(!flag){
		alert("전송 불가능한 파일 형식이 포함되어 있습니다.\n전송 가능: xls, xlsx, pdf, PDF, jpg, jpeg");
		return;
	}
	
	if($('input[name="chkList"]:checked').size()==0){
		alert("전송할 서류를 선택해주세요.");
		return;
	}
	
	var url = "/bankInfo/destinationSelectPopupScreen?dracBicNm=" + dracBicNm;
	openPopup(url, 800, 530);
	
}

function fileViewer(obj, path, type, name){
	
	var url = "/file/fileViewerS3?filePath=" + path + "&fileType="+ type + "&fileNm="+ name+"&docType=S";

	if(type=="pdf"||type=="PDF"){
		openPopup(url, 850, 800);
	}else{
		location.href = url;
	}
}

</script>
</body>
</html>